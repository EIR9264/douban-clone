# 豆瓣电影克隆（Spring Boot + Vue3）实现笔记

> 这份文档用于“以后继续学习/给别人讲解”——尽量直白、指向代码、可验证。

## 1. 启动与依赖（Docker Compose）

- 依赖服务启动：`docker compose up -d`
- 后端启动（你在 VSCode 里 Run Java Program 即可）：`backend/src/main/java/com/douban/DoubanApplication.java`
- 前端启动：进入 `frontend/`，执行 `npm run dev`（或按你的脚本）

### 1.1 为什么浏览器打不开 Redis 6379
- `6379` 是 Redis 的 **TCP** 端口，不是 HTTP 服务，所以 `http://localhost:6379/` 必然打不开。
- 验证 Redis 是否可用（任选其一）：
  - `redis-cli -h localhost -p 6379 ping` -> `PONG`
  - 后端访问热度榜/缓存相关接口无报错（见下文“热度与排行榜”）

### 1.2 Nacos 如何“证明连上了”
- Nacos 控制台：`http://localhost:8848/nacos` → `服务管理` → `服务列表`。
- 本项目为了“开箱即跑”，在 `backend/src/main/resources/application.yml` 默认关闭 Nacos（enabled=false）。
- 需要启用时：将 `spring.cloud.nacos.discovery.enabled`、`spring.cloud.nacos.config.enabled` 改为 `true`，并配置 `server-addr=localhost:8848`；再启动后端即可在控制台看到实例。

### 1.3 MyBatis 为什么不用部署在 Docker
- MyBatis 是 **后端 Java 进程里的 ORM/SQL 框架**（依赖库），不是一个独立服务；因此不需要也无法“单独部署为容器”。
- 验证方式：后端启动日志里会打印 mapper 扫描/SQL 执行；接口能正常分页/聚合查询也间接证明 MyBatis 正常工作。

### 1.4 MinIO 的作用与验证
- 用途：对象存储（预告片、剧照、头像等媒体文件）。
- 后端上传入口：`backend/src/main/java/com/douban/controller/admin/AdminUploadController.java`
- MinIO 访问：通常可用 `http://localhost:9001`（Console）查看 bucket/object；也可通过页面上传后返回的 URL 直接访问资源。

## 2. 登录 + 验证码

- 验证码接口：`backend/src/main/java/com/douban/controller/AuthController.java`、`backend/src/main/java/com/douban/service/CaptchaService.java`
- 前端登录页：`frontend/src/views/Login.vue`
- 关键点：登录时携带 `captchaId + captchaCode`；后端校验通过再签发 JWT。

验证：
- 打开登录页 → 刷新验证码 → 输入正确验证码 → 登录成功返回 token。

## 3. JWT 鉴权与管理员权限

- 拦截器/权限：`backend/src/main/java/com/douban/config/AuthInterceptor.java`
- 设计要点：
  - 普通接口：未登录返回 401，前端按需禁用按钮/提示。
  - 管理接口：统一前缀 `/api/admin/**`，后端校验管理员角色。

## 4. 用户：资料、头像、修改密码、封禁

- 个人资料/密码/头像：`backend/src/main/java/com/douban/controller/UserController.java`
  - 修改密码：`PUT /api/users/me/password`
  - 上传头像：`POST /api/users/me/avatar`（`multipart/form-data`）
- 前端设置页：`frontend/src/views/Settings.vue`
- 管理端用户管理：`backend/src/main/java/com/douban/controller/admin/AdminUserController.java`、`frontend/src/views/admin/AdminUsers.vue`

设计要点：
- **封禁用户**优于删除用户：保留历史评分/评论/点赞等数据，不破坏关联关系。
- **至少保留 1 名管理员**：最后一位管理员不可被降权/封禁，避免系统失去管理入口。

## 5. 电影：列表、详情、搜索、多标签筛选

- 后端：`backend/src/main/java/com/douban/service/MovieService.java`、`backend/src/main/java/com/douban/mapper/MovieMapper.java`
- 前端：`frontend/src/views/Movies.vue`、`frontend/src/views/Search.vue`、`frontend/src/views/MovieDetail.vue`

实现要点：
- 搜索 = 关键词条件 + 多标签条件（MyBatis 动态 SQL 组合）。
- “评分人数/评价人数”来自数据库聚合统计，保证口径真实。

## 6. 评分与收藏（想看/在看/看过）

- 入口：`backend/src/main/java/com/douban/controller/MovieController.java`
  - `POST/GET/DELETE /api/movies/{id}/rating`
  - `POST/DELETE /api/movies/{id}/collect`
- 业务逻辑：`backend/src/main/java/com/douban/service/InteractionService.java`

## 7. 评论与点赞：以 review_likes 为唯一真相

- 核心目标：不要在 `reviews` 表冗余 likes 字段（容易不一致），统一以 `review_likes` 统计。
- 代码：
  - `backend/src/main/java/com/douban/mapper/ReviewMapper.java`（查询返回 `liked` + `likeCount`）
  - `backend/src/main/java/com/douban/service/InteractionService.java`（点赞 toggle：存在则删，不存在则插）
- 数据库迁移：`docs/migrations/review_likes_migration.sql`

前端：
- 详情页评论区：`frontend/src/views/MovieDetail.vue`
- 评论排行：`frontend/src/views/Rankings.vue`

交互规则：
- 未登录：点赞按钮 disabled + tooltip 提示登录（不强制跳转）。
- 已登录：点赞/取消点赞只能一次生效，UI 立即更新并展示当前状态。

## 8. 热度与排行榜（Redis + MySQL 聚合）

- Redis 热度：`backend/src/main/java/com/douban/service/RankingService.java`
  - 常见做法：电影详情访问时 `ZINCRBY`；查询热度榜时按 `ZREVRANGE`。
- 多维榜单：最多评价/最多想看/最多看过等 → 基于 MySQL 聚合（口径真实）。

前端：`frontend/src/views/Rankings.vue`

## 9. 公告/站内信 + WebSocket 推送

- 公告：`backend/src/main/java/com/douban/controller/AnnouncementController.java` + 管理端 `backend/src/main/java/com/douban/controller/admin/AdminAnnouncementController.java`
- 站内信：`backend/src/main/java/com/douban/controller/NotificationController.java`、`backend/src/main/java/com/douban/controller/admin/AdminMessageController.java`
- 推送服务：`backend/src/main/java/com/douban/service/NotificationService.java`
- WebSocket：`backend/src/main/java/com/douban/config/WebSocketConfig.java`
- 前端（未读/弹窗等）：`frontend/src/stores/notification.js`

说明：
- WebSocket 是后端进程的一部分，因此不需要在 Docker 单独部署。

## 10. MinIO：电影预告片/剧照与电影 images JSON

- 管理端上传：`frontend/src/views/admin/AdminMovies.vue` → 调用后端上传接口 → 回写 URL。
- 后端上传：`backend/src/main/java/com/douban/controller/admin/AdminUploadController.java`、`backend/src/main/java/com/douban/service/ObjectStorageService.java`
- 数据结构：`movies.images` 保存 JSON（例如 trailers、stills 等字段）
- 详情页展示：`frontend/src/views/MovieDetail.vue`（简介与评论区之间）

## 11. 常见排错路径（建议）

- 前端 500：先看后端控制台异常栈；再对照请求 URL/参数是否正确。
- Nacos/Redis/MinIO 是否“生效”：不要只看容器在跑，最好用“控制台/命令行/接口行为”三种方式形成闭环。

